# Garmin Watch Face Golden-time PRD

**产品需求文档**  
**版本：** v1.2 Beta  
**日期：** 2026-02-20  
**状态：** Beta 封板

---

## 一、产品概述

### 1.1 产品定义

Golden-time 是一款为摄影师和户外爱好者设计的 Garmin 表盘，实时显示下一次蓝调（Blue Hour）和金调（Golden Hour）的倒计时，帮助用户捕捉最佳光线时刻。

### 1.2 目标用户

- 摄影师（风光、人像、城市摄影）
- 户外爱好者
- 对日出日落时间敏感的用户

### 1.3 支持设备

- Garmin Fenix 7S（主要测试设备）
- 其他支持 Connect IQ SDK 5.2+ 的设备

---

## 二、功能需求

### 2.1 核心功能（✅ 已实现）

#### 2.1.1 时间显示
- **主时间：** 大字号显示当前时间（HH:MM）
- **日期：** 小字号显示星期和日期（WED | FEB 18）
- **状态：** ✅ 已实现

#### 2.1.2 蓝调倒计时（Blue Hour）
- **定义：** 太阳高度角从 -10° 到 -4°
- **显示位置：** 表盘左下角
- **标签：** "Blue"（颜色随时段变化）
- **倒计时格式：** HH:MM
- **当时间处于蓝调区间内，则显示：** NOW
- **无数据显示：** --:--
- **状态：** ✅ 已实现并验证

#### 2.1.3 金调倒计时（Golden Hour）
- **定义：** 太阳高度角从 -4° 到 +6°
- **显示位置：** 表盘右下角
- **标签：** "Golden"（颜色随时段变化）
- **倒计时格式：** HH:MM
- **当时间处于金调区间内，则显示：** NOW
- **无数据显示：** --:--
- **状态：** ✅ 已实现并验证

#### 2.1.4 GPS 定位与倒计时计算
- **自动获取：** 使用设备 GPS 获取当前位置
- **更新频率：** 每日凌晨零点请求一次，计算当日晨与当日夜的数据。每日中午十二点请求一次，计算当日夜与次日晨的数据。缓存并使用。
- **跨越时区 or 经纬度更新：** 首次定位后，或者，单小时内经度变化 ≥ 2.5°（≈10分钟）时，进行一次重算。
- **测试模式：** 可硬编码上海位置（31.2304, 121.4737）
- **状态：** ✅ 已实现并验证

#### 2.1.5 动态 UI（✅ 新增功能）
- **背景图切换：** 根据当前时段（MORNING_BLUE / MORNING_GOLDEN / DAY / EVENING_GOLDEN / EVENING_BLUE / NIGHT）自动切换背景图
- **顶部贴图切换：** 日月图标根据时段动态切换
- **字体颜色调整：** 倒计时标签和数值颜色随时段变化，确保对比度和可读性
- **状态：** ✅ 已实现并验证

### 2.2 时段定义（✅ 已实现）

系统根据太阳高度角和时间，将一天划分为 6 个时段：

| 时段 | 英文标识 | 太阳高度角范围 | 时间特征 | UI 特征 |
|------|----------|----------------|----------|---------|
| 晨蓝调 | MORNING_BLUE | -10° ~ -4° | 日出前 | 蓝色调背景，月亮图标 |
| 晨金调 | MORNING_GOLDEN | -4° ~ +6° | 日出时 | 金色调背景，太阳图标 |
| 白天 | DAY | +6° 以上 | 日间 | 明亮背景，太阳图标 |
| 夜金调 | EVENING_GOLDEN | +6° ~ -4° | 日落时 | 金色调背景，太阳图标 |
| 夜蓝调 | EVENING_BLUE | -4° ~ -10° | 日落后 | 蓝色调背景，月亮图标 |
| 夜间 | NIGHT | -10° 以下 | 夜间 | 深色背景，月亮图标 |

---

## 三、技术架构

### 3.1 技术栈

- **开发语言：** Monkey C
- **SDK 版本：** Connect IQ SDK 8.4.1
- **开发工具：** VS Code + Monkey C 扩展
- **构建工具：** monkeyc + monkeydo

### 3.2 核心模块

#### 3.2.1 LocationService
- **职责：** GPS 定位管理
- **功能：**
  - 请求 GPS 定位
  - 缓存最近一次定位
  - 测试模式支持
- **状态：** ✅ 已实现

#### 3.2.2 SunAltService
- **职责：** 太阳高度角计算和事件扫描
- **功能：**
  - 计算太阳高度角（NOAA 算法）
  - 扫描蓝调/金调事件
  - 缓存 24 小时内的事件
  - 查找下一次事件
- **状态：** ✅ 已实现并验证

#### 3.2.3 Golden-timeView
- **职责：** 表盘 UI 渲染
- **功能：**
  - 绘制时间和日期
  - 绘制蓝调/金调倒计时
  - 处理安全区域（圆形表盘）
  - 动态切换背景图和顶部贴图
  - 动态调整字体颜色
- **状态：** ✅ 已实现

### 3.3 算法实现

#### 3.3.1 太阳高度角计算
- **算法：** NOAA Solar Position Algorithm
- **输入：** 时间戳、纬度、经度
- **输出：** 太阳高度角（度）
- **精度：** 约 0.01°
- **状态：** ✅ 已验证

#### 3.3.2 事件扫描算法

**当前实现（v1.2）：解析解方法（NOAA 标准公式）**

```
1. 计算太阳赤纬 δ
2. 计算时间方程（equation of time）
3. 对于每个阈值角度 θ（-10°、-4°、+6°）：
   - 解时角方程：cos(H) = (sin(θ) - sin(φ)sin(δ)) / (cos(φ)cos(δ))
   - 计算太阳正午：solarNoon = 720 - 4*lon - eqTime + tz*60 (分钟)
   - 计算事件时间：T = solarNoon ± H/15 (本地时间)
   - 转换为 UTC 时间戳
4. 返回时间戳
```

**状态：** ✅ 已验证（Python 单测通过，Monkey C 实现验证通过）

---

## 四、Beta 版本状态

### 4.1 已完成功能 ✅

- [x] 核心倒计时功能（蓝调/金调）
- [x] GPS 定位与自动计算
- [x] 时间和日期显示
- [x] 动态 UI（背景图、顶部贴图、字体颜色）
- [x] 圆形表盘安全区域适配
- [x] 基础算法验证（上海地区）

### 4.2 已知限制 ⚠️

- **地理覆盖：** 仅在中纬度地区（如上海 31.2°N）测试
- **极端情况：** 未测试极昼/极夜场景（高纬度地区）
- **字体：** 使用系统默认字体，未定制
- **设备支持：** 仅在 Fenix 7S 上测试

### 4.3 待优化功能 🔄

- [ ] 极端纬度适配（极昼/极夜处理）
- [ ] 多设备适配测试
- [ ] 定制字体设计
- [ ] 性能优化（电池续航）
- [ ] 多语言支持

---

## 五、验收标准

### 5.1 功能验收（✅ 已通过）

- [x] `[SNAPSHOT]` 输出 `blueTs != null`
- [x] `[SNAPSHOT]` 输出 `goldenTs != null`
- [x] `blueCountdown` 和 `goldenCountdown` 不同
- [x] 时间精度误差 < 15 分钟（对比巧摄专业版）
- [x] 背景图和顶部贴图正确切换
- [x] 字体颜色随时段正确调整

### 5.2 Beta 发布标准（✅ 已达成）

- [x] 核心功能可用
- [x] 无致命 Bug
- [x] 基础场景验证通过
- [x] 构建成功并生成 .iq 文件

---

## 六、技术债务

### 6.1 代码质量

- **冗余代码：** 旧的二分查找函数未删除（_isCrossing, _bisectRoot）
- **魔法数字：** 扫描窗口时间（4:00-10:00）硬编码
- **未使用变量：** 编译警告中提到的未使用局部变量

### 6.2 测试覆盖

- ✅ **Python 单元测试：** 已完成（test_algorithm.py）
- ✅ **状态快照输出：** 已完成（[SNAPSHOT] 日志）
- ✅ **Monkey C 验证：** 已完成（上海地区）
- ❌ **极端场景测试：** 待完成（极昼/极夜、跨时区）

### 6.3 性能优化

- **GPS 请求频率：** 可能需要优化以节省电量
- **UI 刷新频率：** 可能需要优化以减少 CPU 占用

---

## 七、发布计划

### 7.1 Beta 版本（v1.2）

**发布时间：** 2026-02-20  
**发布渠道：** Connect IQ Store Beta  
**文件名：** `Golden-time_beta_20260220_000342.iq`  
**文件大小：** 53KB

**发布说明：**
```
Golden-time Beta 1.2 - 摄影师的黄金时刻表盘

✨ 核心功能：
- 实时蓝调/金调倒计时
- 基于GPS位置自动计算
- 动态UI随时段变化（背景图、日月图标、字体颜色）
- 极简设计，户外可读

⚠️ Beta 版本说明：
- 已测试：基础倒计时功能、UI动态切换（上海地区）
- 待优化：极端纬度适配、极昼极夜处理、多设备测试
- 欢迎反馈：通过 Connect IQ Store 评论或联系开发者

适用设备：Fenix 7S（更多设备即将支持）
```

### 7.2 正式版本（v2.0）计划

**预计时间：** 2026-03  
**计划功能：**
- 极端纬度适配
- 多设备支持
- 定制字体
- 性能优化
- 多语言支持

---

## 八、参考资料

### 8.1 算法参考

- NOAA Solar Position Algorithm
- 巧摄专业版（对比数据）
- 时角方程：cos(H) = (sin(θ) - sin(φ)sin(δ)) / (cos(φ)cos(δ))
- NOAA 太阳正午公式：solarNoon = 720 - 4*longitude - equationOfTime + timezone*60

### 8.2 开发文档

- Garmin Connect IQ SDK 文档
- Monkey C API 参考
- AGENTS.md（工作空间规则）
- WatchFace_UI_Specification.md（UI 设计规范）

---

**变更记录：**
- 2026-02-18 21:21 - 初始版本
- 2026-02-18 22:20 - 更新进度
- 2026-02-18 22:48 - 结构修正：删除猜测性判断，新增已证实事实和已证伪假设
- 2026-02-20 00:16 - Beta 封板：更新为 v1.2，补充动态 UI 功能，更新验收状态，添加 Beta 发布信息
